
name: Deploy to DGX Cloud

on:
  workflow_dispatch:   # Enables manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dgx-cloud-prod  # Must match your GitHub Environment name

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Export DGX/NIM/Riva secrets
        run: |
          echo "NIM_API_URL=${{ secrets.NIM_API_URL }}" >> $GITHUB_ENV
          echo "NGC_API_KEY=${{ secrets.NGC_API_KEY }}" >> $GITHUB_ENV
          echo "NVIDIA_SPEECH_API_KEY=${{ secrets.NVIDIA_SPEECH_API_KEY }}" >> $GITHUB_ENV
          echo "RIVA_ASR_FUNCTION_ID=${{ secrets.RIVA_ASR_FUNCTION_ID }}" >> $GITHUB_ENV
          echo "RIVA_TTS_FUNCTION_ID=${{ secrets.RIVA_TTS_FUNCTION_ID }}" >> $GITHUB_ENV

      - name: Install Node dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found; skipping install."
          fi

      - name: Deploy to DGX Cloud
        run: |
          echo "Logging in to NVIDIA NGC registry..."
          echo "${{ secrets.NGC_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin

          echo "Pulling NIM container..."
          docker pull nvcr.io/nvidia/nim/llm:latest

          echo "Starting NIM container..."
          docker run --gpus all -d -p 8000:8000 nvcr.io/nvidia/nim/llm:latest
