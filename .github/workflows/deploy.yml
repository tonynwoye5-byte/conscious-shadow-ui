
name: Deploy to DGX Cloud

on:
  workflow_dispatch:   # Enables manual trigger
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dgx-cloud-prod  # Must match your Environment name

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Export DGX/NIM/Riva secrets
        run: |
          echo "NIM_API_URL=${{ secrets.NIM_API_URL }}" >> $GITHUB_ENV
          echo "NGC_API_KEY=${{ secrets.NGC_API_KEY }}" >> $GITHUB_ENV
          echo "NVIDIA_SPEECH_API_KEY=${{ secrets.NVIDIA_SPEECH_API_KEY }}" >> $GITHUB_ENV
          echo "RIVA_ASR_FUNCTION_ID=${{ secrets.RIVA_ASR_FUNCTION_ID }}" >> $GITHUB_ENV
          echo "RIVA_TTS_FUNCTION_ID=${{ secrets.RIVA_TTS_FUNCTION_ID }}" >> $GITHUB_ENV

      - name: Install Node dependencies
        run: |
          if [ -f package.json ]; then
            npm ci
          else
            echo "No package.json found; skipping install."
          fi

      # --- choose ONE of the following deploy steps ---

      # Hosted runner (no GPU): trigger deployment in DGX Cloud
      - name: Deploy to DGX Cloud (trigger)
        run: |
          echo "Trigger DGX Cloud deployment here."
          echo "NIM_API_URL=$NIM_API_URL"
          # curl or SSH to your DGX-side deploy script

      # Self-hosted runner (with GPU): run NIM container locally
      # - name: Deploy to DGX Cloud (self-hosted runner)
      #   run: |
      #     echo "${{ secrets.NGC_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
      #     docker pull nvcr.io/nvidia/nim/llm:latest
      #     docker run --gpus all -d -p 8000:8000 nvcr.io/nvidia/nim/llm:latest
